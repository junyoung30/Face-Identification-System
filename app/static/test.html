<!DOCTYPE html>
<html>
<body>
    <h1>Identify Page</h1>

    <video id="camera" width="400" height="300" autoplay></video>

    <div>
        <button id="btn-start">카메라 켜기</button>
        <button id="btn-capture">사진 찍기</button>
        <button id="btn-identify">식별하기</button>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <pre id="result"></pre>

    <script>
        const video = document.getElementById("camera");
        const canvas = document.getElementById("canvas");
        const resultBox = document.getElementById("result");

        const btnStart = document.getElementById("btn-start");
        const btnCapture = document.getElementById("btn-capture");
        const btnIdentify = document.getElementById("btn-identify");

        let stream = null;
        let captureBlob = null;

        btnStart.onclick = startCamera;
        btnCapture.onclick = capturePhoto;
        btnIdentify.onclick = identifyPhoto;

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(s => {
                    stream = s;
                    video.srcObject = stream;
                    console.log("카메라 시작");
                })
                .catch(err => {
                    console.error("카메라 에러:", err);
                })
        }

        function capturePhoto() {
            if (!stream) {
                alert("카메라가 켜져있지 않습니다.");
                return;
            }

            const ctx = canvas.getContext("2d");

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                if (!blob) {
                    alert("이미지 생성 실패");
                    return
                }

                captureBlob = blob;
                console.log("이미지 캡쳐 완료:", blob);
                alert("사진이 캡쳐되었습니다.");
            }, "image/jpeg");
        }

        function identifyPhoto() {
            if (!captureBlob) {
                alert("먼저 사진을 찍어주세요");
                return;
            }

            const formData = new FormData;
            formData.append("file", captureBlob, "capture.jpg");

            fetch("/identify", {
                method: "POST",
                bocy: formData
            })
            .then(res => res.json())
            .then(data => {
                console.log("서버 응답:", data);
                resultBox.textContent = JSON.stringify(data, null, 2);
            })
            .catch(err => {
                console.error("식별 실패:", err);
                alert("식별 실패");
            })
        }
    </script>
</body>
</html>